'use strict';

exports.__esModule = true;

var _getIterator2 = require('babel-runtime/core-js/get-iterator');

var _getIterator3 = _interopRequireDefault(_getIterator2);

var _entries = require('babel-runtime/core-js/object/entries');

var _entries2 = _interopRequireDefault(_entries);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _path = require('path');

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _child_process = require('child_process');

var _makeDir = require('make-dir');

var _makeDir2 = _interopRequireDefault(_makeDir);

var _process = require('./process');

var _process2 = _interopRequireDefault(_process);

var _tempDirectory = require('../utils/temp-directory');

var _tempDirectory2 = _interopRequireDefault(_tempDirectory);

var _pathPattern = require('../utils/path-pattern');

var _pathPattern2 = _interopRequireDefault(_pathPattern);

var _warningMessage = require('../notifications/warning-message');

var _warningMessage2 = _interopRequireDefault(_warningMessage);

var _string = require('../utils/string');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEBUG_LOGGER = (0, _debug2.default)('testcafe:video-recorder');

const VIDEO_EXTENSION = 'mp4';

const TEMP_DIR_PREFIX = 'video';
const TEMP_VIDEO_FILE_PREFIX = 'tmp-video';
const TEMP_MERGE_FILE_PREFIX = TEMP_VIDEO_FILE_PREFIX + '-merge';

const TEMP_MERGE_CONFIG_FILE_PREFIX = 'config';
const TEMP_MERGE_CONFIG_FILE_EXTENSION = 'txt';

class VideoRecorder {
    constructor(browserJob, basePath, opts, encodingOpts, warningLog) {
        this.browserJob = browserJob;
        this.basePath = basePath;
        this.failedOnly = opts.failedOnly;
        this.singleFile = opts.singleFile;
        this.ffmpegPath = opts.ffmpegPath;
        this.customPathPattern = opts.pathPattern;
        this.timeStamp = opts.timeStamp;
        this.encodingOptions = encodingOpts;

        this.warningLog = warningLog;

        this.tempDirectory = new _tempDirectory2.default(TEMP_DIR_PREFIX);
        this.tempVideoPath = '';
        this.tempMergeConfigPath = '';

        this.firstFile = true;

        this.testRunInfo = {};

        this._assignEventHandlers(browserJob);
    }

    _createSafeListener(listener) {
        var _this = this;

        return (() => {
            var _ref = (0, _asyncToGenerator3.default)(function* (...args) {
                try {
                    return yield listener.apply(_this, args);
                } catch (error) {
                    DEBUG_LOGGER(listener && listener.name, error);

                    return void 0;
                }
            });

            return function () {
                return _ref.apply(this, arguments);
            };
        })();
    }

    _assignEventHandlers(browserJob) {
        browserJob.once('start', this._createSafeListener(() => {
            this.tempDirectoryInitializedPromise = this._onBrowserJobStart();

            return this.tempDirectoryInitializedPromise;
        }));

        browserJob.once('done', this._createSafeListener(this._onBrowserJobDone));
        browserJob.on('test-run-create', this._createSafeListener(this._onTestRunCreate));
        browserJob.on('test-run-ready', this._createSafeListener(this._onTestRunReady));
        browserJob.on('test-run-before-done', this._createSafeListener(this._onTestRunBeforeDone));
    }

    _addProblematicPlaceholdersWarning(placeholders) {
        const problematicPlaceholderListStr = (0, _string.getConcatenatedValuesString)(placeholders);
        const suffix = (0, _string.getPluralSuffix)(placeholders);
        const verb = (0, _string.getToBeInPastTense)(placeholders);

        this.warningLog.addWarning(_warningMessage2.default.problematicPathPatternPlaceholderForVideoRecording, problematicPlaceholderListStr, suffix, suffix, verb);
    }

    _getTargetVideoPath(testRunInfo) {
        const test = testRunInfo.test,
              index = testRunInfo.index,
              testRun = testRunInfo.testRun;


        const connection = testRun.browserConnection;

        const pathPattern = new _pathPattern2.default(this.customPathPattern, VIDEO_EXTENSION, {
            testIndex: this.singleFile ? null : index,
            quarantineAttempt: null,
            now: this.timeStamp,
            fixture: this.singleFile ? null : test.fixture.name,
            test: this.singleFile ? null : test.name,
            parsedUserAgent: connection.browserInfo.parsedUserAgent
        });

        pathPattern.on('problematic-placeholders-found', ({ placeholders }) => this._addProblematicPlaceholdersWarning(placeholders));

        return (0, _path.join)(this.basePath, pathPattern.getPath());
    }

    _generateTempNames(id) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const tempFileNames = {
                tempVideoPath: `${TEMP_VIDEO_FILE_PREFIX}-${id}.${VIDEO_EXTENSION}`,
                tempMergeConfigPath: `${TEMP_MERGE_CONFIG_FILE_PREFIX}-${id}.${TEMP_MERGE_CONFIG_FILE_EXTENSION}`,
                tmpMergeName: `${TEMP_MERGE_FILE_PREFIX}-${id}.${VIDEO_EXTENSION}`
            };

            yield _this2.tempDirectoryInitializedPromise;

            for (var _iterator = (0, _entries2.default)(tempFileNames), _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : (0, _getIterator3.default)(_iterator);;) {
                var _ref3;

                if (_isArray) {
                    if (_i >= _iterator.length) break;
                    _ref3 = _iterator[_i++];
                } else {
                    _i = _iterator.next();
                    if (_i.done) break;
                    _ref3 = _i.value;
                }

                const _ref2 = _ref3;
                const tempFile = _ref2[0];
                const tempName = _ref2[1];

                tempFileNames[tempFile] = (0, _path.join)(_this2.tempDirectory.path, tempName);
            }return tempFileNames;
        })();
    }

    _concatVideo(targetVideoPath, { tempVideoPath, tempMergeConfigPath, tmpMergeName }) {
        if (this.firstFile) {
            this.firstFile = false;
            return;
        }

        _fs2.default.writeFileSync(tempMergeConfigPath, `
            file '${targetVideoPath}'
            file '${tempVideoPath}'
        `);

        (0, _child_process.spawnSync)(this.ffmpegPath, ['-y', '-f', 'concat', '-safe', '0', '-i', tempMergeConfigPath, '-c', 'copy', tmpMergeName], { stdio: 'ignore' });
        _fs2.default.copyFileSync(tmpMergeName, tempVideoPath);
    }

    _onBrowserJobStart() {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this3.tempDirectory.init();
        })();
    }

    _onBrowserJobDone() {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this4.tempDirectory.dispose();
        })();
    }

    _onTestRunCreate({ testRun, legacy, quarantine, test, index }) {
        var _this5 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (legacy) return;

            const testRunInfo = { testRun, quarantine, test, index };

            const connection = testRun.browserConnection;

            const connectionCapabilities = yield testRun.browserConnection.provider.hasCustomActionForBrowser(connection.id);

            if (!connectionCapabilities || !connectionCapabilities.hasGetVideoFrameData) {
                _this5.browserJob.warningLog.addWarning(_warningMessage2.default.videoNotSupportedByBrowser, connection.browserInfo.alias);

                return;
            }

            _this5.testRunInfo[index] = testRunInfo;

            testRunInfo.tempFiles = yield _this5._generateTempNames(connection.id);

            testRunInfo.videoRecorder = new _process2.default(testRunInfo.tempFiles.tempVideoPath, _this5.ffmpegPath, connection, _this5.encodingOptions);

            yield testRunInfo.videoRecorder.init();
        })();
    }

    _onTestRunReady(testRunController) {
        var _this6 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const testRunInfo = _this6.testRunInfo[testRunController.index];

            if (!testRunInfo) return;

            yield testRunInfo.videoRecorder.startCapturing();
        })();
    }

    _onTestRunBeforeDone(testRunController) {
        var _this7 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const testRunInfo = _this7.testRunInfo[testRunController.index];

            if (!testRunInfo) return;

            delete _this7.testRunInfo[testRunController.index];

            yield testRunInfo.videoRecorder.finishCapturing();

            const videoPath = _this7._getTargetVideoPath(testRunInfo);

            if (_this7.failedOnly && !testRunController.testRun.errs.length) return;

            yield (0, _makeDir2.default)((0, _path.dirname)(videoPath));

            if (_this7.singleFile) _this7._concatVideo(videoPath, testRunInfo.tempFiles);

            _fs2.default.copyFileSync(testRunInfo.tempFiles.tempVideoPath, videoPath);
        })();
    }
}
exports.default = VideoRecorder;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy92aWRlby1yZWNvcmRlci9pbmRleC5qcyJdLCJuYW1lcyI6WyJERUJVR19MT0dHRVIiLCJWSURFT19FWFRFTlNJT04iLCJURU1QX0RJUl9QUkVGSVgiLCJURU1QX1ZJREVPX0ZJTEVfUFJFRklYIiwiVEVNUF9NRVJHRV9GSUxFX1BSRUZJWCIsIlRFTVBfTUVSR0VfQ09ORklHX0ZJTEVfUFJFRklYIiwiVEVNUF9NRVJHRV9DT05GSUdfRklMRV9FWFRFTlNJT04iLCJWaWRlb1JlY29yZGVyIiwiY29uc3RydWN0b3IiLCJicm93c2VySm9iIiwiYmFzZVBhdGgiLCJvcHRzIiwiZW5jb2RpbmdPcHRzIiwid2FybmluZ0xvZyIsImZhaWxlZE9ubHkiLCJzaW5nbGVGaWxlIiwiZmZtcGVnUGF0aCIsImN1c3RvbVBhdGhQYXR0ZXJuIiwicGF0aFBhdHRlcm4iLCJ0aW1lU3RhbXAiLCJlbmNvZGluZ09wdGlvbnMiLCJ0ZW1wRGlyZWN0b3J5IiwiVGVtcERpcmVjdG9yeSIsInRlbXBWaWRlb1BhdGgiLCJ0ZW1wTWVyZ2VDb25maWdQYXRoIiwiZmlyc3RGaWxlIiwidGVzdFJ1bkluZm8iLCJfYXNzaWduRXZlbnRIYW5kbGVycyIsIl9jcmVhdGVTYWZlTGlzdGVuZXIiLCJsaXN0ZW5lciIsImFyZ3MiLCJhcHBseSIsImVycm9yIiwibmFtZSIsIm9uY2UiLCJ0ZW1wRGlyZWN0b3J5SW5pdGlhbGl6ZWRQcm9taXNlIiwiX29uQnJvd3NlckpvYlN0YXJ0IiwiX29uQnJvd3NlckpvYkRvbmUiLCJvbiIsIl9vblRlc3RSdW5DcmVhdGUiLCJfb25UZXN0UnVuUmVhZHkiLCJfb25UZXN0UnVuQmVmb3JlRG9uZSIsIl9hZGRQcm9ibGVtYXRpY1BsYWNlaG9sZGVyc1dhcm5pbmciLCJwbGFjZWhvbGRlcnMiLCJwcm9ibGVtYXRpY1BsYWNlaG9sZGVyTGlzdFN0ciIsInN1ZmZpeCIsInZlcmIiLCJhZGRXYXJuaW5nIiwiV0FSTklOR19NRVNTQUdFUyIsInByb2JsZW1hdGljUGF0aFBhdHRlcm5QbGFjZWhvbGRlckZvclZpZGVvUmVjb3JkaW5nIiwiX2dldFRhcmdldFZpZGVvUGF0aCIsInRlc3QiLCJpbmRleCIsInRlc3RSdW4iLCJjb25uZWN0aW9uIiwiYnJvd3NlckNvbm5lY3Rpb24iLCJQYXRoUGF0dGVybiIsInRlc3RJbmRleCIsInF1YXJhbnRpbmVBdHRlbXB0Iiwibm93IiwiZml4dHVyZSIsInBhcnNlZFVzZXJBZ2VudCIsImJyb3dzZXJJbmZvIiwiZ2V0UGF0aCIsIl9nZW5lcmF0ZVRlbXBOYW1lcyIsImlkIiwidGVtcEZpbGVOYW1lcyIsInRtcE1lcmdlTmFtZSIsInRlbXBGaWxlIiwidGVtcE5hbWUiLCJwYXRoIiwiX2NvbmNhdFZpZGVvIiwidGFyZ2V0VmlkZW9QYXRoIiwiZnMiLCJ3cml0ZUZpbGVTeW5jIiwic3RkaW8iLCJjb3B5RmlsZVN5bmMiLCJpbml0IiwiZGlzcG9zZSIsImxlZ2FjeSIsInF1YXJhbnRpbmUiLCJjb25uZWN0aW9uQ2FwYWJpbGl0aWVzIiwicHJvdmlkZXIiLCJoYXNDdXN0b21BY3Rpb25Gb3JCcm93c2VyIiwiaGFzR2V0VmlkZW9GcmFtZURhdGEiLCJ2aWRlb05vdFN1cHBvcnRlZEJ5QnJvd3NlciIsImFsaWFzIiwidGVtcEZpbGVzIiwidmlkZW9SZWNvcmRlciIsIlZpZGVvUmVjb3JkZXJQcm9jZXNzIiwidGVzdFJ1bkNvbnRyb2xsZXIiLCJzdGFydENhcHR1cmluZyIsImZpbmlzaENhcHR1cmluZyIsInZpZGVvUGF0aCIsImVycnMiLCJsZW5ndGgiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBRUEsTUFBTUEsZUFBZSxxQkFBTSx5QkFBTixDQUFyQjs7QUFFQSxNQUFNQyxrQkFBa0IsS0FBeEI7O0FBRUEsTUFBTUMsa0JBQXlCLE9BQS9CO0FBQ0EsTUFBTUMseUJBQXlCLFdBQS9C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QixFQUFOO0FBTnNDO0FBT3pDOztBQUVLbEQsd0JBQU4sQ0FBNEJpRCxpQkFBNUIsRUFBK0M7QUFBQTs7QUFBQTtBQUMzQyxrQkFBTWhFLGNBQWMsT0FBS0EsV0FBTCxDQUFpQmdFLGtCQUFrQnRDLEtBQW5DLENBQXBCOztBQUVBLGdCQUFJLENBQUMxQixXQUFMLEVBQ0k7O0FBRUosbUJBQU8sT0FBS0EsV0FBTCxDQUFpQmdFLGtCQUFrQnRDLEtBQW5DLENBQVA7O0FBRUEsa0JBQU0xQixZQUFZOEQsYUFBWixDQUEwQkksZUFBMUIsRUFBTjs7QUFFQSxrQkFBTUMsWUFBWSxPQUFLM0MsbUJBQUwsQ0FBeUJ4QixXQUF6QixDQUFsQjs7QUFFQSxnQkFBSSxPQUFLWixVQUFMLElBQW1CLENBQUM0RSxrQkFBa0JyQyxPQUFsQixDQUEwQnlDLElBQTFCLENBQStCQyxNQUF2RCxFQUNJOztBQUVKLGtCQUFNLHVCQUFRLG1CQUFRRixTQUFSLENBQVIsQ0FBTjs7QUFFQSxnQkFBSSxPQUFLOUUsVUFBVCxFQUNJLE9BQUt3RCxZQUFMLENBQWtCc0IsU0FBbEIsRUFBNkJuRSxZQUFZNkQsU0FBekM7O0FBRUpkLHlCQUFHRyxZQUFILENBQWdCbEQsWUFBWTZELFNBQVosQ0FBc0JoRSxhQUF0QyxFQUFxRHNFLFNBQXJEO0FBcEIyQztBQXFCOUM7QUExSzhCO2tCQUFkdEYsYSIsImZpbGUiOiJ2aWRlby1yZWNvcmRlci9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgeyBqb2luLCBkaXJuYW1lIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgc3Bhd25TeW5jIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgbWFrZURpciBmcm9tICdtYWtlLWRpcic7XG5pbXBvcnQgVmlkZW9SZWNvcmRlclByb2Nlc3MgZnJvbSAnLi9wcm9jZXNzJztcbmltcG9ydCBUZW1wRGlyZWN0b3J5IGZyb20gJy4uL3V0aWxzL3RlbXAtZGlyZWN0b3J5JztcbmltcG9ydCBQYXRoUGF0dGVybiBmcm9tICcuLi91dGlscy9wYXRoLXBhdHRlcm4nO1xuaW1wb3J0IFdBUk5JTkdfTUVTU0FHRVMgZnJvbSAnLi4vbm90aWZpY2F0aW9ucy93YXJuaW5nLW1lc3NhZ2UnO1xuaW1wb3J0IHsgZ2V0UGx1cmFsU3VmZml4LCBnZXRDb25jYXRlbmF0ZWRWYWx1ZXNTdHJpbmcsIGdldFRvQmVJblBhc3RUZW5zZSB9IGZyb20gJy4uL3V0aWxzL3N0cmluZyc7XG5cbmNvbnN0IERFQlVHX0xPR0dFUiA9IGRlYnVnKCd0ZXN0Y2FmZTp2aWRlby1yZWNvcmRlcicpO1xuXG5jb25zdCBWSURFT19FWFRFTlNJT04gPSAnbXA0JztcblxuY29uc3QgVEVNUF9ESVJfUFJFRklYICAgICAgICA9ICd2aWRlbyc7XG5jb25zdCBURU1QX1ZJREVPX0ZJTEVfUFJFRklYID0gJ3RtcC12aWRlbyc7XG5jb25zdCBURU1QX01FUkdFX0ZJTEVfUFJFRklYID0gVEVNUF9WSURFT19GSUxFX1BSRUZJWCArICctbWVyZ2UnO1xuXG5jb25zdCBURU1QX01FUkdFX0NPTkZJR19GSUxFX1BSRUZJWCAgICA9ICdjb25maWcnO1xuY29uc3QgVEVNUF9NRVJHRV9DT05GSUdfRklMRV9FWFRFTlNJT04gPSAndHh0JztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVmlkZW9SZWNvcmRlciB7XG4gICAgY29uc3RydWN0b3IgKGJyb3dzZXJKb2IsIGJhc2VQYXRoLCBvcHRzLCBlbmNvZGluZ09wdHMsIHdhcm5pbmdMb2cpIHtcbiAgICAgICAgdGhpcy5icm93c2VySm9iICAgICAgICA9IGJyb3dzZXJKb2I7XG4gICAgICAgIHRoaXMuYmFzZVBhdGggICAgICAgICAgPSBiYXNlUGF0aDtcbiAgICAgICAgdGhpcy5mYWlsZWRPbmx5ICAgICAgICA9IG9wdHMuZmFpbGVkT25seTtcbiAgICAgICAgdGhpcy5zaW5nbGVGaWxlICAgICAgICA9IG9wdHMuc2luZ2xlRmlsZTtcbiAgICAgICAgdGhpcy5mZm1wZWdQYXRoICAgICAgICA9IG9wdHMuZmZtcGVnUGF0aDtcbiAgICAgICAgdGhpcy5jdXN0b21QYXRoUGF0dGVybiA9IG9wdHMucGF0aFBhdHRlcm47XG4gICAgICAgIHRoaXMudGltZVN0YW1wICAgICAgICAgPSBvcHRzLnRpbWVTdGFtcDtcbiAgICAgICAgdGhpcy5lbmNvZGluZ09wdGlvbnMgICA9IGVuY29kaW5nT3B0cztcblxuICAgICAgICB0aGlzLndhcm5pbmdMb2cgPSB3YXJuaW5nTG9nO1xuXG4gICAgICAgIHRoaXMudGVtcERpcmVjdG9yeSAgICAgICA9IG5ldyBUZW1wRGlyZWN0b3J5KFRFTVBfRElSX1BSRUZJWCk7XG4gICAgICAgIHRoaXMudGVtcFZpZGVvUGF0aCAgICAgICA9ICcnO1xuICAgICAgICB0aGlzLnRlbXBNZXJnZUNvbmZpZ1BhdGggPSAnJztcblxuICAgICAgICB0aGlzLmZpcnN0RmlsZSA9IHRydWU7XG5cbiAgICAgICAgdGhpcy50ZXN0UnVuSW5mbyA9IHt9O1xuXG4gICAgICAgIHRoaXMuX2Fzc2lnbkV2ZW50SGFuZGxlcnMoYnJvd3NlckpvYik7XG4gICAgfVxuXG4gICAgX2NyZWF0ZVNhZmVMaXN0ZW5lciAobGlzdGVuZXIpIHtcbiAgICAgICAgcmV0dXJuIGFzeW5jICguLi5hcmdzKSA9PiB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBsaXN0ZW5lci5hcHBseSh0aGlzLCBhcmdzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIERFQlVHX0xPR0dFUihsaXN0ZW5lciAmJiBsaXN0ZW5lci5uYW1lLCBlcnJvcik7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIF9hc3NpZ25FdmVudEhhbmRsZXJzIChicm93c2VySm9iKSB7XG4gICAgICAgIGJyb3dzZXJKb2Iub25jZSgnc3RhcnQnLCB0aGlzLl9jcmVhdGVTYWZlTGlzdGVuZXIoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy50ZW1wRGlyZWN0b3J5SW5pdGlhbGl6ZWRQcm9taXNlID0gdGhpcy5fb25Ccm93c2VySm9iU3RhcnQoKTtcblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMudGVtcERpcmVjdG9yeUluaXRpYWxpemVkUHJvbWlzZTtcbiAgICAgICAgfSkpO1xuXG4gICAgICAgIGJyb3dzZXJKb2Iub25jZSgnZG9uZScsIHRoaXMuX2NyZWF0ZVNhZmVMaXN0ZW5lcih0aGlzLl9vbkJyb3dzZXJKb2JEb25lKSk7XG4gICAgICAgIGJyb3dzZXJKb2Iub24oJ3Rlc3QtcnVuLWNyZWF0ZScsIHRoaXMuX2NyZWF0ZVNhZmVMaXN0ZW5lcih0aGlzLl9vblRlc3RSdW5DcmVhdGUpKTtcbiAgICAgICAgYnJvd3NlckpvYi5vbigndGVzdC1ydW4tcmVhZHknLCB0aGlzLl9jcmVhdGVTYWZlTGlzdGVuZXIodGhpcy5fb25UZXN0UnVuUmVhZHkpKTtcbiAgICAgICAgYnJvd3NlckpvYi5vbigndGVzdC1ydW4tYmVmb3JlLWRvbmUnLCB0aGlzLl9jcmVhdGVTYWZlTGlzdGVuZXIodGhpcy5fb25UZXN0UnVuQmVmb3JlRG9uZSkpO1xuICAgIH1cblxuICAgIF9hZGRQcm9ibGVtYXRpY1BsYWNlaG9sZGVyc1dhcm5pbmcgKHBsYWNlaG9sZGVycykge1xuICAgICAgICBjb25zdCBwcm9ibGVtYXRpY1BsYWNlaG9sZGVyTGlzdFN0ciA9IGdldENvbmNhdGVuYXRlZFZhbHVlc1N0cmluZyhwbGFjZWhvbGRlcnMpO1xuICAgICAgICBjb25zdCBzdWZmaXggICAgICAgICAgICAgICAgICAgICAgICA9IGdldFBsdXJhbFN1ZmZpeChwbGFjZWhvbGRlcnMpO1xuICAgICAgICBjb25zdCB2ZXJiICAgICAgICAgICAgICAgICAgICAgICAgICA9IGdldFRvQmVJblBhc3RUZW5zZShwbGFjZWhvbGRlcnMpO1xuXG4gICAgICAgIHRoaXMud2FybmluZ0xvZy5hZGRXYXJuaW5nKFdBUk5JTkdfTUVTU0FHRVMucHJvYmxlbWF0aWNQYXRoUGF0dGVyblBsYWNlaG9sZGVyRm9yVmlkZW9SZWNvcmRpbmcsIHByb2JsZW1hdGljUGxhY2Vob2xkZXJMaXN0U3RyLCBzdWZmaXgsIHN1ZmZpeCwgdmVyYik7XG4gICAgfVxuXG4gICAgX2dldFRhcmdldFZpZGVvUGF0aCAodGVzdFJ1bkluZm8pIHtcbiAgICAgICAgY29uc3QgeyB0ZXN0LCBpbmRleCwgdGVzdFJ1biB9ID0gdGVzdFJ1bkluZm87XG5cbiAgICAgICAgY29uc3QgY29ubmVjdGlvbiA9IHRlc3RSdW4uYnJvd3NlckNvbm5lY3Rpb247XG5cbiAgICAgICAgY29uc3QgcGF0aFBhdHRlcm4gPSBuZXcgUGF0aFBhdHRlcm4odGhpcy5jdXN0b21QYXRoUGF0dGVybiwgVklERU9fRVhURU5TSU9OLCB7XG4gICAgICAgICAgICB0ZXN0SW5kZXg6ICAgICAgICAgdGhpcy5zaW5nbGVGaWxlID8gbnVsbCA6IGluZGV4LFxuICAgICAgICAgICAgcXVhcmFudGluZUF0dGVtcHQ6IG51bGwsXG4gICAgICAgICAgICBub3c6ICAgICAgICAgICAgICAgdGhpcy50aW1lU3RhbXAsXG4gICAgICAgICAgICBmaXh0dXJlOiAgICAgICAgICAgdGhpcy5zaW5nbGVGaWxlID8gbnVsbCA6IHRlc3QuZml4dHVyZS5uYW1lLFxuICAgICAgICAgICAgdGVzdDogICAgICAgICAgICAgIHRoaXMuc2luZ2xlRmlsZSA/IG51bGwgOiB0ZXN0Lm5hbWUsXG4gICAgICAgICAgICBwYXJzZWRVc2VyQWdlbnQ6ICAgY29ubmVjdGlvbi5icm93c2VySW5mby5wYXJzZWRVc2VyQWdlbnQsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHBhdGhQYXR0ZXJuLm9uKCdwcm9ibGVtYXRpYy1wbGFjZWhvbGRlcnMtZm91bmQnLCAoeyBwbGFjZWhvbGRlcnMgfSkgPT4gdGhpcy5fYWRkUHJvYmxlbWF0aWNQbGFjZWhvbGRlcnNXYXJuaW5nKHBsYWNlaG9sZGVycykpO1xuXG4gICAgICAgIHJldHVybiBqb2luKHRoaXMuYmFzZVBhdGgsIHBhdGhQYXR0ZXJuLmdldFBhdGgoKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgX2dlbmVyYXRlVGVtcE5hbWVzIChpZCkge1xuICAgICAgICBjb25zdCB0ZW1wRmlsZU5hbWVzID0ge1xuICAgICAgICAgICAgdGVtcFZpZGVvUGF0aDogICAgICAgYCR7VEVNUF9WSURFT19GSUxFX1BSRUZJWH0tJHtpZH0uJHtWSURFT19FWFRFTlNJT059YCxcbiAgICAgICAgICAgIHRlbXBNZXJnZUNvbmZpZ1BhdGg6IGAke1RFTVBfTUVSR0VfQ09ORklHX0ZJTEVfUFJFRklYfS0ke2lkfS4ke1RFTVBfTUVSR0VfQ09ORklHX0ZJTEVfRVhURU5TSU9OfWAsXG4gICAgICAgICAgICB0bXBNZXJnZU5hbWU6ICAgICAgICBgJHtURU1QX01FUkdFX0ZJTEVfUFJFRklYfS0ke2lkfS4ke1ZJREVPX0VYVEVOU0lPTn1gXG4gICAgICAgIH07XG5cbiAgICAgICAgYXdhaXQgdGhpcy50ZW1wRGlyZWN0b3J5SW5pdGlhbGl6ZWRQcm9taXNlO1xuXG4gICAgICAgIGZvciAoY29uc3QgW3RlbXBGaWxlLCB0ZW1wTmFtZV0gb2YgT2JqZWN0LmVudHJpZXModGVtcEZpbGVOYW1lcykpXG4gICAgICAgICAgICB0ZW1wRmlsZU5hbWVzW3RlbXBGaWxlXSA9IGpvaW4odGhpcy50ZW1wRGlyZWN0b3J5LnBhdGgsIHRlbXBOYW1lKTtcblxuICAgICAgICByZXR1cm4gdGVtcEZpbGVOYW1lcztcbiAgICB9XG5cbiAgICBfY29uY2F0VmlkZW8gKHRhcmdldFZpZGVvUGF0aCwgeyB0ZW1wVmlkZW9QYXRoLCB0ZW1wTWVyZ2VDb25maWdQYXRoLCB0bXBNZXJnZU5hbWUgfSkge1xuICAgICAgICBpZiAodGhpcy5maXJzdEZpbGUpIHtcbiAgICAgICAgICAgIHRoaXMuZmlyc3RGaWxlID0gZmFsc2U7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKHRlbXBNZXJnZUNvbmZpZ1BhdGgsIGBcbiAgICAgICAgICAgIGZpbGUgJyR7dGFyZ2V0VmlkZW9QYXRofSdcbiAgICAgICAgICAgIGZpbGUgJyR7dGVtcFZpZGVvUGF0aH0nXG4gICAgICAgIGApO1xuXG4gICAgICAgIHNwYXduU3luYyh0aGlzLmZmbXBlZ1BhdGgsIFsnLXknLCAnLWYnLCAnY29uY2F0JywgJy1zYWZlJywgJzAnLCAnLWknLCB0ZW1wTWVyZ2VDb25maWdQYXRoLCAnLWMnLCAnY29weScsIHRtcE1lcmdlTmFtZV0sIHsgc3RkaW86ICdpZ25vcmUnIH0pO1xuICAgICAgICBmcy5jb3B5RmlsZVN5bmModG1wTWVyZ2VOYW1lLCB0ZW1wVmlkZW9QYXRoKTtcbiAgICB9XG5cbiAgICBhc3luYyBfb25Ccm93c2VySm9iU3RhcnQgKCkge1xuICAgICAgICBhd2FpdCB0aGlzLnRlbXBEaXJlY3RvcnkuaW5pdCgpO1xuICAgIH1cblxuICAgIGFzeW5jIF9vbkJyb3dzZXJKb2JEb25lICgpIHtcbiAgICAgICAgYXdhaXQgdGhpcy50ZW1wRGlyZWN0b3J5LmRpc3Bvc2UoKTtcbiAgICB9XG5cbiAgICBhc3luYyBfb25UZXN0UnVuQ3JlYXRlICh7IHRlc3RSdW4sIGxlZ2FjeSwgcXVhcmFudGluZSwgdGVzdCwgaW5kZXggfSkge1xuICAgICAgICBpZiAobGVnYWN5KVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IHRlc3RSdW5JbmZvID0geyB0ZXN0UnVuLCBxdWFyYW50aW5lLCB0ZXN0LCBpbmRleCB9O1xuXG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb24gPSB0ZXN0UnVuLmJyb3dzZXJDb25uZWN0aW9uO1xuXG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb25DYXBhYmlsaXRpZXMgPSBhd2FpdCB0ZXN0UnVuLmJyb3dzZXJDb25uZWN0aW9uLnByb3ZpZGVyLmhhc0N1c3RvbUFjdGlvbkZvckJyb3dzZXIoY29ubmVjdGlvbi5pZCk7XG5cbiAgICAgICAgaWYgKCFjb25uZWN0aW9uQ2FwYWJpbGl0aWVzIHx8ICFjb25uZWN0aW9uQ2FwYWJpbGl0aWVzLmhhc0dldFZpZGVvRnJhbWVEYXRhKSB7XG4gICAgICAgICAgICB0aGlzLmJyb3dzZXJKb2Iud2FybmluZ0xvZy5hZGRXYXJuaW5nKFdBUk5JTkdfTUVTU0FHRVMudmlkZW9Ob3RTdXBwb3J0ZWRCeUJyb3dzZXIsIGNvbm5lY3Rpb24uYnJvd3NlckluZm8uYWxpYXMpO1xuXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnRlc3RSdW5JbmZvW2luZGV4XSA9IHRlc3RSdW5JbmZvO1xuXG4gICAgICAgIHRlc3RSdW5JbmZvLnRlbXBGaWxlcyA9IGF3YWl0IHRoaXMuX2dlbmVyYXRlVGVtcE5hbWVzKGNvbm5lY3Rpb24uaWQpO1xuXG4gICAgICAgIHRlc3RSdW5JbmZvLnZpZGVvUmVjb3JkZXIgPSBuZXcgVmlkZW9SZWNvcmRlclByb2Nlc3ModGVzdFJ1bkluZm8udGVtcEZpbGVzLnRlbXBWaWRlb1BhdGgsIHRoaXMuZmZtcGVnUGF0aCwgY29ubmVjdGlvbiwgdGhpcy5lbmNvZGluZ09wdGlvbnMpO1xuXG4gICAgICAgIGF3YWl0IHRlc3RSdW5JbmZvLnZpZGVvUmVjb3JkZXIuaW5pdCgpO1xuICAgIH1cblxuICAgIGFzeW5jIF9vblRlc3RSdW5SZWFkeSAodGVzdFJ1bkNvbnRyb2xsZXIpIHtcbiAgICAgICAgY29uc3QgdGVzdFJ1bkluZm8gPSB0aGlzLnRlc3RSdW5JbmZvW3Rlc3RSdW5Db250cm9sbGVyLmluZGV4XTtcblxuICAgICAgICBpZiAoIXRlc3RSdW5JbmZvKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGF3YWl0IHRlc3RSdW5JbmZvLnZpZGVvUmVjb3JkZXIuc3RhcnRDYXB0dXJpbmcoKTtcbiAgICB9XG5cbiAgICBhc3luYyBfb25UZXN0UnVuQmVmb3JlRG9uZSAodGVzdFJ1bkNvbnRyb2xsZXIpIHtcbiAgICAgICAgY29uc3QgdGVzdFJ1bkluZm8gPSB0aGlzLnRlc3RSdW5JbmZvW3Rlc3RSdW5Db250cm9sbGVyLmluZGV4XTtcblxuICAgICAgICBpZiAoIXRlc3RSdW5JbmZvKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGRlbGV0ZSB0aGlzLnRlc3RSdW5JbmZvW3Rlc3RSdW5Db250cm9sbGVyLmluZGV4XTtcblxuICAgICAgICBhd2FpdCB0ZXN0UnVuSW5mby52aWRlb1JlY29yZGVyLmZpbmlzaENhcHR1cmluZygpO1xuXG4gICAgICAgIGNvbnN0IHZpZGVvUGF0aCA9IHRoaXMuX2dldFRhcmdldFZpZGVvUGF0aCh0ZXN0UnVuSW5mbyk7XG5cbiAgICAgICAgaWYgKHRoaXMuZmFpbGVkT25seSAmJiAhdGVzdFJ1bkNvbnRyb2xsZXIudGVzdFJ1bi5lcnJzLmxlbmd0aClcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBhd2FpdCBtYWtlRGlyKGRpcm5hbWUodmlkZW9QYXRoKSk7XG5cbiAgICAgICAgaWYgKHRoaXMuc2luZ2xlRmlsZSlcbiAgICAgICAgICAgIHRoaXMuX2NvbmNhdFZpZGVvKHZpZGVvUGF0aCwgdGVzdFJ1bkluZm8udGVtcEZpbGVzKTtcblxuICAgICAgICBmcy5jb3B5RmlsZVN5bmModGVzdFJ1bkluZm8udGVtcEZpbGVzLnRlbXBWaWRlb1BhdGgsIHZpZGVvUGF0aCk7XG4gICAgfVxufVxuIl19
