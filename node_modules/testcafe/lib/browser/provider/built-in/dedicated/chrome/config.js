'use strict';

exports.__esModule = true;

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _isNan = require('babel-runtime/core-js/number/is-nan');

var _isNan2 = _interopRequireDefault(_isNan);

exports.default = function (configString) {
    if (!configCache[configString]) configCache[configString] = getNewConfig(configString);

    return configCache[configString];
};

var _chromeEmulatedDevicesList = require('chrome-emulated-devices-list');

var _chromeEmulatedDevicesList2 = _interopRequireDefault(_chromeEmulatedDevicesList);

var _lodash = require('lodash');

var _argumentParsing = require('../../../utils/argument-parsing');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const HEADLESS_DEFAULT_WIDTH = 1280;
const HEADLESS_DEFAULT_HEIGHT = 800;

const AVAILABLE_MODES = ['userProfile', 'headless', 'emulation'];

const configCache = {};

function hasCustomProfile(userArgs) {
    return !!userArgs.match(/--user-data-dir=/);
}

function parseModes(modesStr, userArgs) {
    const parsed = (0, _argumentParsing.splitEscaped)(modesStr, ':');
    const path = (0, _argumentParsing.getPathFromParsedModes)(parsed, AVAILABLE_MODES);
    const detectedModes = (0, _argumentParsing.getModes)(parsed, AVAILABLE_MODES);
    let optionsString = '';

    if (parsed.length) optionsString = parsed.shift();

    while (parsed.length) optionsString += ':' + parsed.shift();

    const modes = {
        path: path,
        userProfile: detectedModes.userProfile || hasCustomProfile(userArgs),
        headless: detectedModes.headless,
        emulation: detectedModes.emulation || detectedModes.headless
    };

    return { modes, optionsString };
}

function simplifyDeviceName(deviceName) {
    return deviceName.replace(/\s/g, '').toLowerCase();
}

function findDevice(deviceName) {
    const simpleName = simplifyDeviceName(deviceName);

    return _chromeEmulatedDevicesList2.default.filter(device => simplifyDeviceName(device.title).indexOf(simpleName) >= 0)[0];
}

function getDeviceBasedOptions(deviceName, orientation) {
    if (!deviceName) return {};

    const deviceData = findDevice(deviceName);

    if (!deviceData) return {};

    const mobile = deviceData.capabilities.indexOf('mobile') >= 0;

    if (!orientation) orientation = mobile ? 'vertical' : 'horizontal';

    return {
        mobile: mobile,
        orientation: orientation,
        touch: deviceData.capabilities.indexOf('touch') >= 0,
        width: deviceData.screen[orientation].width,
        height: deviceData.screen[orientation].height,
        scaleFactor: deviceData.screen['device-pixel-ratio'],
        userAgent: deviceData['user-agent']
    };
}

function parseOptions(str, modes) {
    const parsed = (0, _argumentParsing.splitEscaped)(str, ';');

    const baseOptions = {
        width: modes.headless ? HEADLESS_DEFAULT_WIDTH : 0,
        height: modes.headless ? HEADLESS_DEFAULT_HEIGHT : 0,
        scaleFactor: 0,
        mobile: false,
        cdpPort: (0, _argumentParsing.findMatch)(parsed, /^cdpPort=(.*)/)
    };

    const deviceName = (0, _argumentParsing.findMatch)(parsed, /^device=(.*)/);
    const orientation = (0, _argumentParsing.findMatch)(parsed, /^orientation=(.*)/);
    const deviceBasedOptions = getDeviceBasedOptions(deviceName, orientation);

    let specifiedDeviceOptions = {
        orientation: orientation,
        touch: (0, _argumentParsing.hasMatch)(parsed, /^touch=/) ? (0, _argumentParsing.isMatchTrue)(parsed, /^touch=(.*)/) : void 0,
        mobile: (0, _argumentParsing.isMatchTrue)(parsed, /^mobile=(.*)/),
        width: Number((0, _argumentParsing.findMatch)(parsed, /^width=(.*)/) || NaN),
        height: Number((0, _argumentParsing.findMatch)(parsed, /^height=(.*)/) || NaN),
        scaleFactor: Number((0, _argumentParsing.findMatch)(parsed, /^scaleFactor=(.*)/) || NaN),
        userAgent: (0, _argumentParsing.findMatch)(parsed, /^userAgent=(.*)/)
    };

    specifiedDeviceOptions = (0, _lodash.pickBy)(specifiedDeviceOptions, optionValue => {
        return optionValue !== void 0 && optionValue !== '' && !(0, _isNan2.default)(optionValue);
    });

    return (0, _assign2.default)(baseOptions, deviceBasedOptions, specifiedDeviceOptions);
}

function getNewConfig(configString) {
    var _parseConfig = (0, _argumentParsing.parseConfig)(configString);

    const userArgs = _parseConfig.userArgs,
          modesString = _parseConfig.modesString;

    var _parseModes = parseModes(modesString, userArgs);

    const modes = _parseModes.modes,
          optionsString = _parseModes.optionsString;

    const options = parseOptions(optionsString, modes);

    return (0, _assign2.default)({ userArgs }, modes, options);
}

module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2RlZGljYXRlZC9jaHJvbWUvY29uZmlnLmpzIl0sIm5hbWVzIjpbImNvbmZpZ1N0cmluZyIsImNvbmZpZ0NhY2hlIiwiZ2V0TmV3Q29uZmlnIiwiSEVBRExFU1NfREVGQVVMVF9XSURUSCIsIkhFQURMRVNTX0RFRkFVTFRfSEVJR0hUIiwiQVZBSUxBQkxFX01PREVTIiwiaGFzQ3VzdG9tUHJvZmlsZSIsInVzZXJBcmdzIiwibWF0Y2giLCJwYXJzZU1vZGVzIiwibW9kZXNTdHIiLCJwYXJzZWQiLCJwYXRoIiwiZGV0ZWN0ZWRNb2RlcyIsIm9wdGlvbnNTdHJpbmciLCJsZW5ndGgiLCJzaGlmdCIsIm1vZGVzIiwidXNlclByb2ZpbGUiLCJoZWFkbGVzcyIsImVtdWxhdGlvbiIsInNpbXBsaWZ5RGV2aWNlTmFtZSIsImRldmljZU5hbWUiLCJyZXBsYWNlIiwidG9Mb3dlckNhc2UiLCJmaW5kRGV2aWNlIiwic2ltcGxlTmFtZSIsImVtdWxhdGVkRGV2aWNlcyIsImZpbHRlciIsImRldmljZSIsInRpdGxlIiwiaW5kZXhPZiIsImdldERldmljZUJhc2VkT3B0aW9ucyIsIm9yaWVudGF0aW9uIiwiZGV2aWNlRGF0YSIsIm1vYmlsZSIsImNhcGFiaWxpdGllcyIsInRvdWNoIiwid2lkdGgiLCJzY3JlZW4iLCJoZWlnaHQiLCJzY2FsZUZhY3RvciIsInVzZXJBZ2VudCIsInBhcnNlT3B0aW9ucyIsInN0ciIsImJhc2VPcHRpb25zIiwiY2RwUG9ydCIsImRldmljZUJhc2VkT3B0aW9ucyIsInNwZWNpZmllZERldmljZU9wdGlvbnMiLCJOdW1iZXIiLCJOYU4iLCJvcHRpb25WYWx1ZSIsIm1vZGVzU3RyaW5nIiwib3B0aW9ucyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O2tCQW9IZSxVQUFVQSxZQUFWLEVBQXdCO0FBQ25DLFFBQUksQ0FBQ0MsWUFBWUQsWUFBWixDQUFMLEVBQ0lD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Q0FBeEQ7QUFDSCxLQUZ3QixDQUF6Qjs7QUFJQSxXQUFPLHNCQUFjTixXQUFkLEVBQTJCRSxrQkFBM0IsRUFBK0NDLHNCQUEvQyxDQUFQO0FBQ0g7O0FBR0QsU0FBUzlDLFlBQVQsQ0FBdUJGLFlBQXZCLEVBQXFDO0FBQUEsdUJBQ0Msa0NBQVlBLFlBQVosQ0FERDs7QUFBQSxVQUN6Qk8sUUFEeUIsZ0JBQ3pCQSxRQUR5QjtBQUFBLFVBQ2Y2QyxXQURlLGdCQUNmQSxXQURlOztBQUFBLHNCQUVDM0MsV0FBVzJDLFdBQVgsRUFBd0I3QyxRQUF4QixDQUZEOztBQUFBLFVBRXpCVSxLQUZ5QixlQUV6QkEsS0FGeUI7QUFBQSxVQUVsQkgsYUFGa0IsZUFFbEJBLGFBRmtCOztBQUdqQyxVQUFNdUMsVUFBNEJWLGFBQWE3QixhQUFiLEVBQTRCRyxLQUE1QixDQUFsQzs7QUFFQSxXQUFPLHNCQUFjLEVBQUVWLFFBQUYsRUFBZCxFQUE0QlUsS0FBNUIsRUFBbUNvQyxPQUFuQyxDQUFQO0FBQ0giLCJmaWxlIjoiYnJvd3Nlci9wcm92aWRlci9idWlsdC1pbi9kZWRpY2F0ZWQvY2hyb21lL2NvbmZpZy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBlbXVsYXRlZERldmljZXMgZnJvbSAnY2hyb21lLWVtdWxhdGVkLWRldmljZXMtbGlzdCc7XG5pbXBvcnQgeyBwaWNrQnkgYXMgZmlsdGVyUHJvcGVydGllcyB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQge1xuICAgIGhhc01hdGNoLCBmaW5kTWF0Y2gsIGlzTWF0Y2hUcnVlLCBnZXRNb2Rlcywgc3BsaXRFc2NhcGVkLCBnZXRQYXRoRnJvbVBhcnNlZE1vZGVzLCBwYXJzZUNvbmZpZ1xufSBmcm9tICcuLi8uLi8uLi91dGlscy9hcmd1bWVudC1wYXJzaW5nJztcblxuXG5jb25zdCBIRUFETEVTU19ERUZBVUxUX1dJRFRIICA9IDEyODA7XG5jb25zdCBIRUFETEVTU19ERUZBVUxUX0hFSUdIVCA9IDgwMDtcblxuY29uc3QgQVZBSUxBQkxFX01PREVTID0gWyd1c2VyUHJvZmlsZScsICdoZWFkbGVzcycsICdlbXVsYXRpb24nXTtcblxuY29uc3QgY29uZmlnQ2FjaGUgPSB7fTtcblxuZnVuY3Rpb24gaGFzQ3VzdG9tUHJvZmlsZSAodXNlckFyZ3MpIHtcbiAgICByZXR1cm4gISF1c2VyQXJncy5tYXRjaCgvLS11c2VyLWRhdGEtZGlyPS8pO1xufVxuXG5mdW5jdGlvbiBwYXJzZU1vZGVzIChtb2Rlc1N0ciwgdXNlckFyZ3MpIHtcbiAgICBjb25zdCBwYXJzZWQgICAgICAgID0gc3BsaXRFc2NhcGVkKG1vZGVzU3RyLCAnOicpO1xuICAgIGNvbnN0IHBhdGggICAgICAgICAgPSBnZXRQYXRoRnJvbVBhcnNlZE1vZGVzKHBhcnNlZCwgQVZBSUxBQkxFX01PREVTKTtcbiAgICBjb25zdCBkZXRlY3RlZE1vZGVzID0gZ2V0TW9kZXMocGFyc2VkLCBBVkFJTEFCTEVfTU9ERVMpO1xuICAgIGxldCBvcHRpb25zU3RyaW5nID0gJyc7XG5cbiAgICBpZiAocGFyc2VkLmxlbmd0aClcbiAgICAgICAgb3B0aW9uc1N0cmluZyA9IHBhcnNlZC5zaGlmdCgpO1xuXG4gICAgd2hpbGUgKHBhcnNlZC5sZW5ndGgpXG4gICAgICAgIG9wdGlvbnNTdHJpbmcgKz0gJzonICsgcGFyc2VkLnNoaWZ0KCk7XG5cbiAgICBjb25zdCBtb2RlcyA9IHtcbiAgICAgICAgcGF0aDogICAgICAgIHBhdGgsXG4gICAgICAgIHVzZXJQcm9maWxlOiBkZXRlY3RlZE1vZGVzLnVzZXJQcm9maWxlIHx8IGhhc0N1c3RvbVByb2ZpbGUodXNlckFyZ3MpLFxuICAgICAgICBoZWFkbGVzczogICAgZGV0ZWN0ZWRNb2Rlcy5oZWFkbGVzcyxcbiAgICAgICAgZW11bGF0aW9uOiAgIGRldGVjdGVkTW9kZXMuZW11bGF0aW9uIHx8IGRldGVjdGVkTW9kZXMuaGVhZGxlc3NcbiAgICB9O1xuXG4gICAgcmV0dXJuIHsgbW9kZXMsIG9wdGlvbnNTdHJpbmcgfTtcbn1cblxuZnVuY3Rpb24gc2ltcGxpZnlEZXZpY2VOYW1lIChkZXZpY2VOYW1lKSB7XG4gICAgcmV0dXJuIGRldmljZU5hbWUucmVwbGFjZSgvXFxzL2csICcnKS50b0xvd2VyQ2FzZSgpO1xufVxuXG5mdW5jdGlvbiBmaW5kRGV2aWNlIChkZXZpY2VOYW1lKSB7XG4gICAgY29uc3Qgc2ltcGxlTmFtZSA9IHNpbXBsaWZ5RGV2aWNlTmFtZShkZXZpY2VOYW1lKTtcblxuICAgIHJldHVybiBlbXVsYXRlZERldmljZXMuZmlsdGVyKGRldmljZSA9PiBzaW1wbGlmeURldmljZU5hbWUoZGV2aWNlLnRpdGxlKS5pbmRleE9mKHNpbXBsZU5hbWUpID49IDApWzBdO1xufVxuXG5mdW5jdGlvbiBnZXREZXZpY2VCYXNlZE9wdGlvbnMgKGRldmljZU5hbWUsIG9yaWVudGF0aW9uKSB7XG4gICAgaWYgKCFkZXZpY2VOYW1lKVxuICAgICAgICByZXR1cm4ge307XG5cbiAgICBjb25zdCBkZXZpY2VEYXRhID0gZmluZERldmljZShkZXZpY2VOYW1lKTtcblxuICAgIGlmICghZGV2aWNlRGF0YSlcbiAgICAgICAgcmV0dXJuIHt9O1xuXG4gICAgY29uc3QgbW9iaWxlID0gZGV2aWNlRGF0YS5jYXBhYmlsaXRpZXMuaW5kZXhPZignbW9iaWxlJykgPj0gMDtcblxuICAgIGlmICghb3JpZW50YXRpb24pXG4gICAgICAgIG9yaWVudGF0aW9uID0gbW9iaWxlID8gJ3ZlcnRpY2FsJyA6ICdob3Jpem9udGFsJztcblxuICAgIHJldHVybiB7XG4gICAgICAgIG1vYmlsZTogICAgICBtb2JpbGUsXG4gICAgICAgIG9yaWVudGF0aW9uOiBvcmllbnRhdGlvbixcbiAgICAgICAgdG91Y2g6ICAgICAgIGRldmljZURhdGEuY2FwYWJpbGl0aWVzLmluZGV4T2YoJ3RvdWNoJykgPj0gMCxcbiAgICAgICAgd2lkdGg6ICAgICAgIGRldmljZURhdGEuc2NyZWVuW29yaWVudGF0aW9uXS53aWR0aCxcbiAgICAgICAgaGVpZ2h0OiAgICAgIGRldmljZURhdGEuc2NyZWVuW29yaWVudGF0aW9uXS5oZWlnaHQsXG4gICAgICAgIHNjYWxlRmFjdG9yOiBkZXZpY2VEYXRhLnNjcmVlblsnZGV2aWNlLXBpeGVsLXJhdGlvJ10sXG4gICAgICAgIHVzZXJBZ2VudDogICBkZXZpY2VEYXRhWyd1c2VyLWFnZW50J10sXG4gICAgfTtcbn1cblxuZnVuY3Rpb24gcGFyc2VPcHRpb25zIChzdHIsIG1vZGVzKSB7XG4gICAgY29uc3QgcGFyc2VkID0gc3BsaXRFc2NhcGVkKHN0ciwgJzsnKTtcblxuICAgIGNvbnN0IGJhc2VPcHRpb25zID0ge1xuICAgICAgICB3aWR0aDogICAgICAgbW9kZXMuaGVhZGxlc3MgPyBIRUFETEVTU19ERUZBVUxUX1dJRFRIIDogMCxcbiAgICAgICAgaGVpZ2h0OiAgICAgIG1vZGVzLmhlYWRsZXNzID8gSEVBRExFU1NfREVGQVVMVF9IRUlHSFQgOiAwLFxuICAgICAgICBzY2FsZUZhY3RvcjogMCxcbiAgICAgICAgbW9iaWxlOiAgICAgIGZhbHNlLFxuICAgICAgICBjZHBQb3J0OiAgICAgZmluZE1hdGNoKHBhcnNlZCwgL15jZHBQb3J0PSguKikvKVxuICAgIH07XG5cbiAgICBjb25zdCBkZXZpY2VOYW1lICAgICAgICAgPSBmaW5kTWF0Y2gocGFyc2VkLCAvXmRldmljZT0oLiopLyk7XG4gICAgY29uc3Qgb3JpZW50YXRpb24gICAgICAgID0gZmluZE1hdGNoKHBhcnNlZCwgL15vcmllbnRhdGlvbj0oLiopLyk7XG4gICAgY29uc3QgZGV2aWNlQmFzZWRPcHRpb25zID0gZ2V0RGV2aWNlQmFzZWRPcHRpb25zKGRldmljZU5hbWUsIG9yaWVudGF0aW9uKTtcblxuICAgIGxldCBzcGVjaWZpZWREZXZpY2VPcHRpb25zID0ge1xuICAgICAgICBvcmllbnRhdGlvbjogb3JpZW50YXRpb24sXG4gICAgICAgIHRvdWNoOiAgICAgICBoYXNNYXRjaChwYXJzZWQsIC9edG91Y2g9LykgPyBpc01hdGNoVHJ1ZShwYXJzZWQsIC9edG91Y2g9KC4qKS8pIDogdm9pZCAwLFxuICAgICAgICBtb2JpbGU6ICAgICAgaXNNYXRjaFRydWUocGFyc2VkLCAvXm1vYmlsZT0oLiopLyksXG4gICAgICAgIHdpZHRoOiAgICAgICBOdW1iZXIoZmluZE1hdGNoKHBhcnNlZCwgL153aWR0aD0oLiopLykgfHwgTmFOKSxcbiAgICAgICAgaGVpZ2h0OiAgICAgIE51bWJlcihmaW5kTWF0Y2gocGFyc2VkLCAvXmhlaWdodD0oLiopLykgfHwgTmFOKSxcbiAgICAgICAgc2NhbGVGYWN0b3I6IE51bWJlcihmaW5kTWF0Y2gocGFyc2VkLCAvXnNjYWxlRmFjdG9yPSguKikvKSB8fCBOYU4pLFxuICAgICAgICB1c2VyQWdlbnQ6ICAgZmluZE1hdGNoKHBhcnNlZCwgL151c2VyQWdlbnQ9KC4qKS8pXG4gICAgfTtcblxuICAgIHNwZWNpZmllZERldmljZU9wdGlvbnMgPSBmaWx0ZXJQcm9wZXJ0aWVzKHNwZWNpZmllZERldmljZU9wdGlvbnMsIG9wdGlvblZhbHVlID0+IHtcbiAgICAgICAgcmV0dXJuIG9wdGlvblZhbHVlICE9PSB2b2lkIDAgJiYgb3B0aW9uVmFsdWUgIT09ICcnICYmICFOdW1iZXIuaXNOYU4ob3B0aW9uVmFsdWUpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oYmFzZU9wdGlvbnMsIGRldmljZUJhc2VkT3B0aW9ucywgc3BlY2lmaWVkRGV2aWNlT3B0aW9ucyk7XG59XG5cblxuZnVuY3Rpb24gZ2V0TmV3Q29uZmlnIChjb25maWdTdHJpbmcpIHtcbiAgICBjb25zdCB7IHVzZXJBcmdzLCBtb2Rlc1N0cmluZyB9ID0gcGFyc2VDb25maWcoY29uZmlnU3RyaW5nKTtcbiAgICBjb25zdCB7IG1vZGVzLCBvcHRpb25zU3RyaW5nIH0gID0gcGFyc2VNb2Rlcyhtb2Rlc1N0cmluZywgdXNlckFyZ3MpO1xuICAgIGNvbnN0IG9wdGlvbnMgICAgICAgICAgICAgICAgICAgPSBwYXJzZU9wdGlvbnMob3B0aW9uc1N0cmluZywgbW9kZXMpO1xuXG4gICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oeyB1c2VyQXJncyB9LCBtb2Rlcywgb3B0aW9ucyk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIChjb25maWdTdHJpbmcpIHtcbiAgICBpZiAoIWNvbmZpZ0NhY2hlW2NvbmZpZ1N0cmluZ10pXG4gICAgICAgIGNvbmZpZ0NhY2hlW2NvbmZpZ1N0cmluZ10gPSBnZXROZXdDb25maWcoY29uZmlnU3RyaW5nKTtcblxuICAgIHJldHVybiBjb25maWdDYWNoZVtjb25maWdTdHJpbmddO1xufVxuIl19
